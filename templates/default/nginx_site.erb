upstream <%= node['hostname'] %> {
server 127.0.0.1:<%= @int_port_fwd %> fail_timeout=0;
}

server {
listen 80;
return 301 https://$host$request_uri;
}

server {
listen 443;
server_name <%= node['hostname'] %>.<%= node['domain'] %>;


<% if @ssl_enabled == true -%>
    ssl on;
    ssl_certificate <%= @ssl_certificate %>;
    ssl_certificate_key <%= @ssl_certificate_key %>;

<% else -%>
    ssl off;
<% end -%>

location / {
proxy_set_header        Host $host;
proxy_set_header        X-Real-IP $remote_addr;
proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header        X-Forwarded-Proto $scheme;
proxy_redirect http:// https://;
proxy_pass              http://<%= @hostname %>;
client_max_body_size 10M;
}
}
